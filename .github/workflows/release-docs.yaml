name: ðŸš€ Generate documentation

on:
  workflow_call:
  pull_request:
  
# cancel in-progress runs on new commits to same PR (gitub.event.number)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.sha }}
  cancel-in-progress: true

jobs:
  docs:

    runs-on: ubuntu-latest
    name: ðŸ“š Generate PDF from Markdown

    strategy:
      matrix:
        docs-paths: [
          "machines/uscleaner-m-1/manual/fr",
          "machines/metalfog-m-2/manual/fr",
          "desktop/fr"
        ] 

    steps:

      - name: ðŸ“š Checkout Repo
        uses: actions/checkout@v3

      - name: â›ï¸ Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: â›ï¸ Setup node
        uses: actions/setup-node@v3.4.1
        with:
          node-version: '16.x'
          cache: 'pnpm'
        
      - name: ðŸ“¦ Install dependencies
        run: pnpm install

      - name: â“ Check if doc building is necessary
        id: doc-build-check
        run: |
          pnpm exec changeset status --since main --output changeset.json &&
          echo "misc-present="$(cat > changeset.json | jq '.releases[] | select(.name == "@metalizzsas/nuster-misc") | .name') >> $GITHUB_OUTPUT

      - name: ðŸ“‚ Create output directory
        if: steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        run: mkdir -p libs/misc/documentation/output

      - name: ðŸ“ Generate pdf for all docs
        if: steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        uses: docker://pandoc/extra:3.1
        with:
          args: "-d libs/misc/documentation/${{ matrix.docs-paths }}/export.yaml --template libs/misc/documentation/utils/eisvogel.tex"
          
      - name: ðŸ“¦ Upload pdf to artifacts
        if: github.event_name == 'pull_request' && steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        uses: actions/upload-artifact@v3
        with:
          name: output
          path: libs/misc/documentation/output/

      - name: â“ Find first pdf file of folder
        if: github.event_name == 'workflow_call' && steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        id: find_pdf
        run: |
          echo "pdf-path="$(find libs/misc/documentation/output -type f -name '*.pdf' -print -quit) >> $GITHUB_OUTPUT &&
          echo "pdf-name="$(find libs/misc/documentation/output -type f -name '*.pdf' -printf "%f\n") >> $GITHUB_OUTPUT

      - name: ðŸ“– Parse package.json
        if: github.event_name == 'workflow_call' && steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        id: get_misc_version
        run: |
          echo "misc-version="$(cat libs/misc/package.json | jq -r '.version') >> $GITHUB_OUTPUT

      - name: â›­ Get nuster-misc latest tag
        if: github.event_name == 'workflow_call' && steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        id: get_tag_id
        run: |
          curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: token $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/metalizzsas/nusterkit/releases/tags/@metalizzsas/nuster-misc@$MISC_VERSION | echo "tag-id="$(jq -r '.id') >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MISC_VERSION: ${{ steps.get_misc_version.outputs.misc-version }}

      - name: ðŸ“¦ Upload pdf to release
        if: github.event_name == 'workflow_call' && steps.doc-build-check.outputs.misc-present == '@metalizzsas/nuster-misc'
        run: |
          curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: token $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/octet-stream" \
          https://uploads.github.com/repos/metalizzsas/nusterkit/releases/$RELEASE_ID/assets?name=$FILE_NAME \
          --data-binary "@$FILE_PATH"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ steps.get_tag_id.outputs.tag-id }}
          FILE_PATH: ${{ steps.find_pdf.outputs.pdf-path }}
          FILE_NAME: ${{ steps.find_pdf.outputs.pdf-name }}