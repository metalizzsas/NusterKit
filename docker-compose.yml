version: "2"
volumes: 
  nuster-data:
services:
  mongodb:
    image: mongo:4.2
    restart: always
    network_mode: 'host'
    volumes: 
      - 'nuster-data:/data'
  nuster-turbine:
    build: ./nuster-turbine
    network_mode: "host"
    depends_on: 
      - "mongodb"
    volumes:
      - 'nuster-data:/data'
    environment:
      DISABLE_AUTH: 'true'
    labels:
      io.balena.features.supervisor-api: '1'
  nuster-desktop:
    build: ./nuster-desktop/
    restart: always
    network_mode: host
    depends_on: 
      - "nuster-turbine"
      - "mongodb"
    labels:
      io.balena.features.supervisor-api: '1'
  nuster-kiosk:
    image: balenablocks/browser:latest
    privileged: true # required for UDEV to find plugged in peripherals such as a USB mouse
    network_mode: host
    depends_on:
      - "nuster-turbine"
      - "mongodb"
      - 'nuster-desktop'
    environment:
      DISPLAY_NUM: 0
      LAUNCH_URL: 'http://127.0.0.1:3000/machine'
      KIOSK: 1
      ENABLE_GPU: 1
      #ROTATE_DISPLAY: 'right'
      #TOUCHSCREEN: 'wch Touch'
      PERSISTANT: 1
      WINDOW_SIZE: 1024, 600
      FLAGS: "--overscroll-history-navigation=0 --user-data-dir=/data/chromium-user-data"
    volumes:
      - 'nuster-data:/data'
  wifi-connect:
    build: ./wifi-connect/
    restart: always
    network_mode: host
    privileged: true
    labels: 
      io.balena.features.dbus: "1"
      io.balena.features.firmware: "1"
    cap_add:
      - NET_ADMIN
    environment:
      PORTAL_LISTENING_PORT: 8080
      PORTAL_SSID: 'Nuster Wifi Configurator'